// Sistema de Gestión Escolar - Prisma Schema
// Base de datos: MySQL

generator client {
  provider = "prisma-client-js"
  output   = "../generated/prisma"
  engineType = "binary"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

// ========================================
// ENUMS
// ========================================

enum Role {
  ADMIN
  TEACHER
  STUDENT
  PARENT
}

enum Gender {
  MALE
  FEMALE
  OTHER
}

enum AttendanceStatus {
  PRESENT
  ABSENT
  LATE
  EXCUSED
}

enum TaskType {
  HOMEWORK
  EXAM
  PROJECT
  QUIZ
}

enum SubmissionType {
  PHYSICAL
  DIGITAL
}

enum PaymentStatus {
  PENDING
  PAID
  OVERDUE
  CANCELLED
}

enum GradeScale {
  NUMERIC      // 0-20
  LETTER       // AD, A, B, C
}

// ========================================
// 1. MÓDULO: USUARIOS Y ESCUELAS
// ========================================

model School {
  id        String   @id @default(uuid())
  name      String
  address   String?
  phone     String?
  email     String?
  logo      String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  users           User[]
  students        Student[]
  teachers        Teacher[]
  parents         Parent[]
  academicYears   AcademicYear[]
  levels          Level[]
  workshops       Workshop[]
  payments        Payment[]

  @@index([name])
}

model User {
  id        String    @id @default(uuid())
  email     String    @unique
  password  String
  role      Role
  schoolId  String
  isActive  Boolean   @default(true)
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  deletedAt DateTime?

  // Relations
  school       School        @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  student      Student?
  teacher      Teacher?
  parent       Parent?
  refreshTokens RefreshToken[]

  @@index([email])
  @@index([schoolId])
  @@index([role, schoolId])
}

model RefreshToken {
  id        String   @id @default(uuid())
  token     String   @unique @db.VarChar(512)
  userId    String
  expiresAt DateTime
  createdAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([token])
}

model Student {
  id              String   @id @default(uuid())
  userId          String   @unique
  schoolId        String
  firstName       String
  lastName        String
  dateOfBirth     DateTime
  gender          Gender
  address         String?
  phone           String?
  enrollmentCode  String   @unique
  profilePhoto    String?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // Relations
  user            User              @relation(fields: [userId], references: [id], onDelete: Cascade)
  school          School            @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  parents         StudentParent[]
  enrollments     Enrollment[]
  attendances     Attendance[]
  taskSubmissions TaskSubmission[]
  grades          Grade[]
  payments        Payment[]
  reportCards     ReportCard[]
  workshopEnrollments WorkshopEnrollment[]

  @@index([schoolId])
  @@index([enrollmentCode])
  @@index([userId])
}

model Teacher {
  id           String   @id @default(uuid())
  userId       String   @unique
  schoolId     String
  firstName    String
  lastName     String
  dateOfBirth  DateTime?
  gender       Gender?
  phone        String?
  address      String?
  specialty    String?
  profilePhoto String?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  // Relations
  user     User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  school   School   @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  courses  Course[]

  @@index([schoolId])
  @@index([userId])
}

model Parent {
  id           String   @id @default(uuid())
  userId       String   @unique
  schoolId     String
  firstName    String
  lastName     String
  phone        String?
  address      String?
  occupation   String?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  // Relations
  user     User            @relation(fields: [userId], references: [id], onDelete: Cascade)
  school   School          @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  students StudentParent[]

  @@index([schoolId])
  @@index([userId])
}

model StudentParent {
  id         String   @id @default(uuid())
  studentId  String
  parentId   String
  relationship String  // "Padre", "Madre", "Tutor", etc.
  isPrimary  Boolean  @default(false)
  createdAt  DateTime @default(now())

  student Student @relation(fields: [studentId], references: [id], onDelete: Cascade)
  parent  Parent  @relation(fields: [parentId], references: [id], onDelete: Cascade)

  @@unique([studentId, parentId])
  @@index([studentId])
  @@index([parentId])
}

// ========================================
// 2. MÓDULO: ESTRUCTURA ACADÉMICA
// ========================================

model AcademicYear {
  id        String   @id @default(uuid())
  schoolId  String
  name      String   // "2024"
  startDate DateTime
  endDate   DateTime
  isCurrent Boolean  @default(false)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  school  School   @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  periods Period[]
  courses Course[]

  @@index([schoolId])
  @@index([isCurrent, schoolId])
}

model Period {
  id             String   @id @default(uuid())
  academicYearId String
  name           String   // "1er Bimestre", "2do Trimestre"
  startDate      DateTime
  endDate        DateTime
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  // Relations
  academicYear AcademicYear @relation(fields: [academicYearId], references: [id], onDelete: Cascade)
  grades       Grade[]

  @@index([academicYearId])
}

model Level {
  id        String   @id @default(uuid())
  schoolId  String
  name      String   // "Inicial", "Primaria", "Secundaria"
  order     Int      // Para ordenar
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  school School  @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  grades GradeLevel[]

  @@index([schoolId])
}

model GradeLevel {
  id        String   @id @default(uuid())
  levelId   String
  name      String   // "1ro", "2do", "3ro", etc.
  order     Int
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  level      Level       @relation(fields: [levelId], references: [id], onDelete: Cascade)
  sections   Section[]
  subjects   Subject[]

  @@index([levelId])
}

model Section {
  id          String   @id @default(uuid())
  gradeLevelId String
  name        String   // "A", "B", "C"
  capacity    Int?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  gradeLevel  GradeLevel   @relation(fields: [gradeLevelId], references: [id], onDelete: Cascade)
  classrooms  Classroom[]

  @@index([gradeLevelId])
}

model Classroom {
  id         String   @id @default(uuid())
  sectionId  String
  name       String   // "Aula 101", "Salón A"
  capacity   Int?
  location   String?
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  // Relations
  section     Section      @relation(fields: [sectionId], references: [id], onDelete: Cascade)
  enrollments Enrollment[]
  courses     Course[]

  @@index([sectionId])
}

// ========================================
// 3. MÓDULO: ASIGNATURAS Y CURSOS
// ========================================

model Subject {
  id           String   @id @default(uuid())
  gradeLevelId String
  name         String   // "Matemática", "Comunicación"
  code         String?
  description  String?  @db.Text
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  // Relations
  gradeLevel GradeLevel           @relation(fields: [gradeLevelId], references: [id], onDelete: Cascade)
  courses    Course[]
  curriculum CurriculumUnit[]

  @@index([gradeLevelId])
}

model Course {
  id             String   @id @default(uuid())
  academicYearId String
  subjectId      String
  teacherId      String
  classroomId    String
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  // Relations
  academicYear AcademicYear @relation(fields: [academicYearId], references: [id], onDelete: Cascade)
  subject      Subject      @relation(fields: [subjectId], references: [id], onDelete: Cascade)
  teacher      Teacher      @relation(fields: [teacherId], references: [id], onDelete: Cascade)
  classroom    Classroom    @relation(fields: [classroomId], references: [id], onDelete: Cascade)
  schedules    Schedule[]
  attendances  Attendance[]
  tasks        Task[]
  grades       Grade[]

  @@index([academicYearId])
  @@index([subjectId])
  @@index([teacherId])
  @@index([classroomId])
}

// ========================================
// 4. MÓDULO: MATRÍCULA
// ========================================

model Enrollment {
  id          String   @id @default(uuid())
  studentId   String
  classroomId String
  enrollDate  DateTime @default(now())
  status      String   @default("ACTIVE") // "ACTIVE", "INACTIVE", "GRADUATED"
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  student   Student   @relation(fields: [studentId], references: [id], onDelete: Cascade)
  classroom Classroom @relation(fields: [classroomId], references: [id], onDelete: Cascade)

  @@unique([studentId, classroomId])
  @@index([studentId])
  @@index([classroomId])
}

// ========================================
// 5. MÓDULO: HORARIOS
// ========================================

model Schedule {
  id        String   @id @default(uuid())
  courseId  String
  dayOfWeek Int      // 0=Domingo, 1=Lunes, ..., 6=Sábado
  startTime String   // "08:00"
  endTime   String   // "09:30"
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  course Course @relation(fields: [courseId], references: [id], onDelete: Cascade)

  @@index([courseId])
  @@index([dayOfWeek])
}

// ========================================
// 6. MÓDULO: ASISTENCIA
// ========================================

model Attendance {
  id        String           @id @default(uuid())
  courseId  String
  studentId String
  date      DateTime
  status    AttendanceStatus
  notes     String?          @db.Text
  createdAt DateTime         @default(now())
  updatedAt DateTime         @updatedAt

  // Relations
  course  Course  @relation(fields: [courseId], references: [id], onDelete: Cascade)
  student Student @relation(fields: [studentId], references: [id], onDelete: Cascade)

  @@unique([courseId, studentId, date])
  @@index([courseId])
  @@index([studentId])
  @@index([date])
}

// ========================================
// 7. MÓDULO: CURRÍCULO
// ========================================

model CurriculumUnit {
  id          String   @id @default(uuid())
  subjectId   String
  name        String   // "Unidad 1: Números Naturales"
  description String?  @db.Text
  order       Int
  month       Int?     // 1-12 (para programación mensual)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  subject Subject           @relation(fields: [subjectId], references: [id], onDelete: Cascade)
  topics  CurriculumTopic[]

  @@index([subjectId])
}

model CurriculumTopic {
  id               String   @id @default(uuid())
  curriculumUnitId String
  name             String   // "Adición y Sustracción"
  description      String?  @db.Text
  order            Int
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  // Relations
  curriculumUnit CurriculumUnit @relation(fields: [curriculumUnitId], references: [id], onDelete: Cascade)

  @@index([curriculumUnitId])
}

// ========================================
// 8. MÓDULO: TAREAS Y EXÁMENES
// ========================================

model Task {
  id          String   @id @default(uuid())
  courseId    String
  title       String
  description String?  @db.Text
  type        TaskType
  dueDate     DateTime?
  fileUrl     String?  // OPCIONAL - El profesor puede o no subir archivo
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  course      Course           @relation(fields: [courseId], references: [id], onDelete: Cascade)
  submissions TaskSubmission[]

  @@index([courseId])
  @@index([dueDate])
}

model TaskSubmission {
  id             String         @id @default(uuid())
  taskId         String
  studentId      String
  submissionType SubmissionType
  fileUrl        String?        // Solo si es digital
  notes          String?        @db.Text
  submittedAt    DateTime       @default(now())
  grade          Float?         // Nota de la tarea
  feedback       String?        @db.Text
  gradedAt       DateTime?
  createdAt      DateTime       @default(now())
  updatedAt      DateTime       @updatedAt

  // Relations
  task    Task    @relation(fields: [taskId], references: [id], onDelete: Cascade)
  student Student @relation(fields: [studentId], references: [id], onDelete: Cascade)

  @@unique([taskId, studentId])
  @@index([taskId])
  @@index([studentId])
}

// ========================================
// 9. MÓDULO: NOTAS
// ========================================

model Grade {
  id          String   @id @default(uuid())
  courseId    String
  studentId   String
  periodId    String
  score       Float    // Nota numérica (0-20) o convertida
  scaleType   GradeScale @default(NUMERIC)
  letterGrade String?  // "AD", "A", "B", "C"
  observation String?  @db.Text
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  course  Course  @relation(fields: [courseId], references: [id], onDelete: Cascade)
  student Student @relation(fields: [studentId], references: [id], onDelete: Cascade)
  period  Period  @relation(fields: [periodId], references: [id], onDelete: Cascade)

  @@unique([courseId, studentId, periodId])
  @@index([courseId])
  @@index([studentId])
  @@index([periodId])
}

model ReportCard {
  id        String   @id @default(uuid())
  studentId String
  periodId  String?  // Opcional si es anual
  year      String   // "2024"
  fileUrl   String   // URL del Excel subido
  uploadedAt DateTime @default(now())
  createdAt DateTime @default(now())

  // Relations
  student Student @relation(fields: [studentId], references: [id], onDelete: Cascade)

  @@index([studentId])
  @@index([year])
}

// ========================================
// 10. MÓDULO: PAGOS
// ========================================

model Payment {
  id            String        @id @default(uuid())
  schoolId      String
  studentId     String
  amount        Float
  description   String        // "Pensión Marzo 2024"
  dueDate       DateTime
  paidDate      DateTime?
  status        PaymentStatus @default(PENDING)
  paymentMethod String?       // "Efectivo", "Transferencia", "Tarjeta"
  transactionId String?       // ID de Stripe/MercadoPago
  receiptUrl    String?       // URL del comprobante
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt

  // Relations
  school  School  @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  student Student @relation(fields: [studentId], references: [id], onDelete: Cascade)

  @@index([schoolId])
  @@index([studentId])
  @@index([status])
  @@index([dueDate])
}

// ========================================
// 11. MÓDULO: TALLERES
// ========================================

model Workshop {
  id          String   @id @default(uuid())
  schoolId    String
  name        String   // "Taller de Robótica"
  description String?  @db.Text
  instructor  String?
  schedule    String?  // "Lunes y Miércoles 3:00 PM"
  capacity    Int?
  startDate   DateTime?
  endDate     DateTime?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  school      School               @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  enrollments WorkshopEnrollment[]

  @@index([schoolId])
}

model WorkshopEnrollment {
  id         String   @id @default(uuid())
  workshopId String
  studentId  String
  enrolledAt DateTime @default(now())
  createdAt  DateTime @default(now())

  // Relations
  workshop Workshop @relation(fields: [workshopId], references: [id], onDelete: Cascade)
  student  Student  @relation(fields: [studentId], references: [id], onDelete: Cascade)

  @@unique([workshopId, studentId])
  @@index([workshopId])
  @@index([studentId])
}

// ========================================
// 12. MÓDULO: AUDITORÍA
// ========================================

enum AuditAction {
  CREATE
  UPDATE
  DELETE
  LOGIN
  LOGOUT
}

model AuditLog {
  id          String      @id @default(uuid())
  userId      String?
  userEmail   String?
  userRole    String?
  schoolId    String?
  action      AuditAction
  resource    String      // "grades", "payments", "students", etc.
  resourceId  String?     // ID del recurso afectado
  method      String      // "POST", "PATCH", "DELETE"
  path        String      // "/api/grades/123"
  ip          String?
  userAgent   String?     @db.Text
  statusCode  Int?
  duration    Int?        // milliseconds
  success     Boolean     @default(true)
  errorMessage String?    @db.Text
  metadata    Json?       // Datos adicionales (antes/después)
  createdAt   DateTime    @default(now())

  @@index([userId])
  @@index([schoolId])
  @@index([action])
  @@index([resource])
  @@index([createdAt])
}

// ========================================
// 13. MÓDULO: NOTIFICACIONES
// ========================================

enum NotificationType {
  INFO
  WARNING
  SUCCESS
  ERROR
  PAYMENT_DUE
  GRADE_POSTED
  TASK_ASSIGNED
  ATTENDANCE_ALERT
  ANNOUNCEMENT
}

enum NotificationChannel {
  SYSTEM    // Notificación interna del sistema
  EMAIL
  SMS
  PUSH
}

model Notification {
  id        String             @id @default(uuid())
  userId    String
  schoolId  String
  type      NotificationType
  channel   NotificationChannel @default(SYSTEM)
  title     String
  message   String             @db.Text
  data      Json?              // Datos adicionales (ej: { gradeId: "xxx" })
  isRead    Boolean            @default(false)
  readAt    DateTime?
  sentAt    DateTime?
  createdAt DateTime           @default(now())

  @@index([userId])
  @@index([schoolId])
  @@index([type])
  @@index([isRead])
  @@index([createdAt])
}
